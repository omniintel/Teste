<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vídeo, Relógio, Clima e Temporizador</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
      background-color: rgb(1, 1, 20);
      width: 100%;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: white;
      overflow: hidden;
    }
    video {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100vw;
      height: auto;
      max-height: 100vh;
      aspect-ratio: 16/9;
    }
    #clockContainer, #weatherBox, #timerContainer {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(6px);
      border-radius: 1vw;
      padding: 0.8vw 1.2vw;
      text-align: center;
    }
    #clockContainer {
      position: absolute;
      top: 1vh;
      left: 1vw;
    }
    #weatherBox {
      position: absolute;
      top: 1vh;
      right: 1vw;
      display: none;
    }
    #timerContainer {
      position: absolute;
      bottom: 1vh;
      left: 1vw;
      font-size: clamp(1.2rem, 2vw, 3rem);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #timerDisplay {
      font-weight: bold;
    }
    #cornerImage {
      position: absolute;
      bottom: 1vh;
      right: 1vw;
      width: clamp(50px, 8vw, 160px);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<video id="backgroundVideo" autoplay muted playsinline>
  <source id="videoSource" src="" type="video/mp4">
</video>

<div id="clockContainer">
  <div id="dateText">Carregando data...</div>
  <div id="timeText"></div>
</div>

<div id="weatherBox">
  <div class="emoji">☀️ - Santa Rosa</div>
  <div class="temperature">--</div>
</div>

<div id="timerContainer">
  <div id="timerDisplay">00:00</div>
</div>

<img id="cornerImage" src="https://omniintel.github.io/Teste/logo.png" alt="Omniintel">

<!-- Sons -->
<audio id="startSound" src="https://omniintel.github.io/Teste/timer.mp4"></audio>
<audio id="alertSound" src="https://omniintel.github.io/Teste/timer.mp4"></audio>
<audio id="endSound" src="https://omniintel.github.io/Teste/timer.mp4"></audio>
<audio id="pauseEndSound" src="https://omniintel.github.io/Teste/timer.mp4"></audio>

<script>
  const supabaseUrl = 'https://hgxuakniyncpbuvksiql.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhneHVha25peW5jcGJ1dmtzaXFsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODcyNTA2MCwiZXhwIjoyMDY0MzAxMDYwfQ.PqFYkPC-87s3regeKRhfMsZi9t_at-LxQTP23RGOyEo';
  const { createClient } = supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseKey);

  let videos = [];
  let currentVideoIndex = 0;

  async function loadVideosFromSupabase() {
    const { data, error } = await supabaseClient
      .from('videosnobrearte')
      .select('video_url');
    if (data) {
      videos = data.map(v => v.video_url);
      playCurrentVideo();
    }
  }

  function playCurrentVideo() {
    const video = document.getElementById('backgroundVideo');
    const source = document.getElementById('videoSource');
    source.src = videos[currentVideoIndex];
    video.load();
    video.play();
    video.onended = () => {
      currentVideoIndex = (currentVideoIndex + 1) % videos.length;
      playCurrentVideo();
    };
  }

  document.addEventListener('DOMContentLoaded', loadVideosFromSupabase);

  // Temporizador
  const timerContainer = document.getElementById('timerContainer');
  const timerDisplay = document.getElementById('timerDisplay');
  const startSound = document.getElementById('startSound');
  const alertSound = document.getElementById('alertSound');
  const endSound = document.getElementById('endSound');
  const pauseEndSound = document.getElementById('pauseEndSound');

  let timerData = {};
  let isRunning = false;
  let isPause = false;
  let timeLeft = 0;
  let currentCircuit = 0;
  let interval;
  let countdownActive = false;

  function playSound(sound) {
    sound.currentTime = 0;
    sound.play();
  }

  async function fetchTimerData() {
    const { data } = await supabaseClient
      .from('cronometro')
      .select('*')
      .single();
    timerData = data;
  }

  function startTimer() {
    if (!timerData) return;
    isRunning = true;
    isPause = false;
    currentCircuit = 1;
    timeLeft = timerData.temp;
    playSound(startSound);
    setColorNormal();
    updateDisplay();
    interval = setInterval(runTimer, 1000);
  }

  function runTimer() {
    timeLeft--;

    if (!isPause && timeLeft === parseInt(timerData.min)) {
      playSound(alertSound);
      setColorAlert();
    }

    if (timeLeft <= 0) {
      if (!isPause) {
        if (currentCircuit < timerData.circ) {
          isPause = true;
          playSound(endSound);
          timeLeft = timerData.paus;
          setColorPause();
          countdownActive = true;
        } else {
          stopTimer();
          playSound(endSound);
          setColorNormal();
          return;
        }
      } else {
        if (countdownActive) {
          countdownActive = false;
          playCountdown(() => {
            isPause = false;
            currentCircuit++;
            timeLeft = timerData.temp;
            playSound(startSound);
            setColorNormal();
          });
          return;
        }
      }
    }
    updateDisplay();
  }

  function playCountdown(callback) {
    let count = 3;
    const countdown = setInterval(() => {
      playSound(pauseEndSound);
      count--;
      if (count <= 0) {
        clearInterval(countdown);
        callback();
      }
    }, 1000);
  }

  function stopTimer() {
    isRunning = false;
    clearInterval(interval);
  }

  function updateDisplay() {
    const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
    const s = String(timeLeft % 60).padStart(2, '0');
    timerDisplay.textContent = `${m}:${s}`;
  }

  function setColorAlert() {
    timerContainer.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
  }
  function setColorPause() {
    timerContainer.style.backgroundColor = 'rgba(0, 0, 255, 0.7)';
  }
  function setColorNormal() {
    timerContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
  }

  async function monitorTimer() {
    await fetchTimerData();
    if (timerData.play === 1 && !isRunning) {
      startTimer();
    } else if (timerData.play === 0 && isRunning) {
      stopTimer();
      setColorNormal();
    }
  }
  setInterval(monitorTimer, 500);

</script>
</body>
</html>
