<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>OmniPlayer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }
    #player-wrapper {
      width: 100%;
      height: 300px;
      background: #000;
      margin-bottom: 20px;
    }
    #player {
      width: 100%;
      height: 100%;
    }
    #toggle-sync {
      padding: 10px 20px;
      background: #00c3ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #playlist {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .video-item {
      background: #222;
      padding: 10px;
      border-radius: 8px;
      width: 150px;
    }
    .thumbnail {
      width: 100%;
      border-radius: 4px;
    }
    .title {
      margin-top: 5px;
      font-size: 14px;
      color: #ddd;
    }
  </style>
</head>
<body>
  <h1>üéÆ OmniPlayer</h1>
  <div id="player-wrapper">
    <div id="player"></div>
  </div>
  <button id="toggle-sync">üîÅ Sincronizar</button>
  <div id="playlist"></div>

  <script>
    const supabaseUrl = 'https://hgxuakniyncpbuvksiql.supabase.co';
    const supabaseKey = 'eyJhbGciOi...'; // sua chave
    const playlistTable = 'videos';
    const syncTable = 'current_video';

    let playlist = [];
    let currentIndex = 0;
    let currentVideoId = '';
    let player = null;

    const generateEmbedUrl = (url) => {
      const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);
      return match ? `https://www.youtube.com/embed/${match[1]}?enablejsapi=1&rel=0&controls=0&autoplay=1` : null;
    };

    const fetchVideos = async () => {
      const res = await fetch(`${supabaseUrl}/rest/v1/${playlistTable}?select=*`, {
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${supabaseKey}`
        }
      });
      return res.ok ? await res.json() : [];
    };

    const loadPlaylist = async () => {
      playlist = await fetchVideos();
      playlist.sort((a, b) => a.id - b.id);
      const container = document.getElementById('playlist');
      container.innerHTML = '';
      playlist.forEach((video, index) => {
        const item = document.createElement('div');
        item.className = 'video-item';

        const youtubeId = video.youtube_id.split('/embed/')[1]?.split('?')[0];

        const thumbnail = document.createElement('img');
        thumbnail.src = `https://img.youtube.com/vi/${youtubeId}/default.jpg`;
        thumbnail.className = 'thumbnail';

        const title = document.createElement('div');
        title.className = 'title';
        title.innerText = video.title || 'V√≠deo';

        item.appendChild(thumbnail);
        item.appendChild(title);
        container.appendChild(item);
      });

      if (playlist.length > 0) {
        currentIndex = 0;
        playVideo(playlist[0].youtube_id);
      }
    };

    const playVideo = async (embedUrl) => {
      const videoId = embedUrl.split('/embed/')[1].split('?')[0];
      currentVideoId = videoId;

      const iframe = document.createElement('iframe');
      iframe.id = 'ytplayer';
      iframe.src = `${embedUrl}&enablejsapi=1`;
      iframe.frameBorder = 0;
      iframe.allow = 'autoplay; encrypted-media';
      iframe.allowFullscreen = true;
      iframe.width = '100%';
      iframe.height = '100%';

      const playerDiv = document.getElementById('player');
      playerDiv.innerHTML = '';
      playerDiv.appendChild(iframe);

      player = new YT.Player('ytplayer', {
        events: {
          'onStateChange': onPlayerStateChange
        }
      });
    };

    const onPlayerStateChange = (event) => {
      if (event.data === YT.PlayerState.ENDED) {
        currentIndex = (currentIndex + 1) % playlist.length;
        playVideo(playlist[currentIndex].youtube_id);
      }
    };

    const checkSyncButton = async () => {
      const res = await fetch(`${supabaseUrl}/rest/v1/${syncTable}?id=eq.1`, {
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${supabaseKey}`
        }
      });
      if (!res.ok) return;
      const data = await res.json();
      const buttonValue = data[0]?.Button || 0;
      if (buttonValue === 1) {
        await fetch(`${supabaseUrl}/rest/v1/${syncTable}?id=eq.1`, {
          method: 'PATCH',
          headers: {
            'apikey': supabaseKey,
            'Authorization': `Bearer ${supabaseKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ Button: 0 })
        });
        location.reload();
      }
    };

    document.getElementById('toggle-sync').addEventListener('click', async () => {
      await fetch(`${supabaseUrl}/rest/v1/${syncTable}?id=eq.1`, {
        method: 'PATCH',
        headers: {
          'apikey': supabaseKey,
          'Authorization': `Bearer ${supabaseKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ Button: 1 })
      });
    });

    const initYouTubeAPI = () => {
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    };

    initYouTubeAPI();

    window.onload = async () => {
      await loadPlaylist();
      setInterval(() => checkSyncButton(), 500); // Verifica a cada meio segundo
    };
  </script>
</body>
</html>
