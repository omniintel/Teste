<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>OmniPlayer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      padding: 20px;
    }
    #player-wrapper {
      width: 100%;
      height: 300px;
      background: #000;
      margin-bottom: 20px;
    }
    #player {
      width: 100%;
      height: 100%;
    }
    #toggle-sync {
      padding: 10px 20px;
      background: #00c3ff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #playlist {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .video-item {
      background: #222;
      padding: 10px;
      border-radius: 8px;
      width: 150px;
      cursor: pointer;
    }
    .thumbnail {
      width: 100%;
      border-radius: 4px;
    }
    .title {
      margin-top: 5px;
      font-size: 14px;
      color: #ddd;
    }
  </style>
</head>
<body>
  <h1>üéÆ OmniPlayer</h1>
  <div id="player-wrapper">
    <div id="player"></div>
  </div>
  <button id="toggle-sync">üîÅ For√ßar Sincronizar</button>
  <div id="playlist"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const supabaseUrl = 'https://hgxuakniyncpbuvksiql.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhneHVha25peW5jcGJ1dmtzaXFsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODcyNTA2MCwiZXhwIjoyMDY0MzAxMDYwfQ.PqFYkPC-87s3regeKRhfMsZi9t_at-LxQTP23RGOyEo'; // sua chave aqui
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const playlistTable = 'videos';
  const syncTable = 'current_video';

  let playlist = [];
  let currentIndex = 0;
  let player = null;
  let syncIdAtual = null;

  function extrairYoutubeId(link) {
    const match = link.match(/(?:youtube\.com\/.*v=|youtu\.be\/|embed\/)([\w-]{11})/);
    return match ? match[1] : null;
  }

  function gerarEmbedUrl(link) {
    const id = extrairYoutubeId(link);
    return id ? `https://www.youtube.com/embed/${id}?autoplay=1&enablejsapi=1&controls=0&rel=0` : link;
  }

  async function carregarPlaylist() {
    const { data, error } = await supabase.from(playlistTable).select('*').order('id', { ascending: true });
    if (error) {
      console.error(error);
      return;
    }
    playlist = data;
    renderizarPlaylist();
  }

  function renderizarPlaylist() {
    const container = document.getElementById('playlist');
    container.innerHTML = '';
    playlist.forEach((video) => {
      const item = document.createElement('div');
      item.className = 'video-item';

      const youtubeId = extrairYoutubeId(video.youtube_id);
      const thumbnail = document.createElement('img');
      thumbnail.src = youtubeId
        ? `https://img.youtube.com/vi/${youtubeId}/default.jpg`
        : 'https://via.placeholder.com/150';
      thumbnail.className = 'thumbnail';

      const title = document.createElement('div');
      title.className = 'title';
      title.innerText = video.title || 'V√≠deo';

      item.appendChild(thumbnail);
      item.appendChild(title);
      item.onclick = () => reproduzirVideoPorId(video.id);
      container.appendChild(item);
    });
  }

  async function reproduzirVideoPorId(id) {
    const video = playlist.find(v => v.id === id);
    if (!video) return;
    currentIndex = playlist.findIndex(v => v.id === id);
    reproduzir(video.youtube_id, video.id);
  }

  async function reproduzir(link, id) {
    const embed = gerarEmbedUrl(link);
    const playerDiv = document.getElementById('player');
    playerDiv.innerHTML = `<iframe id="ytplayer" src="${embed}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="width:100%; height:100%;"></iframe>`;

    syncIdAtual = id;
    await atualizarSync(id, link);

    inicializarPlayer();
  }

  async function atualizarSync(syncid, link) {
    await supabase.from(syncTable).update({
      syncid: syncid,
      sync: link
    }).eq('id', 1);
  }

  async function checarSync() {
    const { data, error } = await supabase.from(syncTable).select('*').eq('id', 1).single();
    if (error || !data) {
      console.error(error);
      return;
    }

    if (data.syncid !== syncIdAtual) {
      const video = playlist.find(v => v.id === data.syncid);
      if (video) {
        currentIndex = playlist.findIndex(v => v.id === video.id);
        reproduzir(video.youtube_id, video.id);
      }
    }
  }

  function avancar() {
    currentIndex = (currentIndex + 1) % playlist.length;
    const proximoVideo = playlist[currentIndex];
    reproduzir(proximoVideo.youtube_id, proximoVideo.id);
  }

  function inicializarPlayer() {
    const iframe = document.getElementById('ytplayer');
    if (!iframe) return;
    if (player) player.destroy();

    player = new YT.Player('ytplayer', {
      events: {
        'onStateChange': (event) => {
          if (event.data === YT.PlayerState.ENDED) {
            avancar();
          }
        }
      }
    });
  }

  function carregarAPIDoYoutube() {
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
  }

  window.onYouTubeIframeAPIReady = () => {
    inicializarPlayer();
  };

  setInterval(() => {
    checarSync();
  }, 500); // Verifica sincroniza√ß√£o a cada 500ms

  document.getElementById('toggle-sync').addEventListener('click', async () => {
    const { data } = await supabase.from(syncTable).select('*').eq('id', 1).single();
    if (data) {
      const video = playlist.find(v => v.id === data.syncid);
      if (video) {
        currentIndex = playlist.findIndex(v => v.id === video.id);
        reproduzir(video.youtube_id, video.id);
      }
    }
  });

  window.onload = async () => {
    await carregarPlaylist();
    const { data } = await supabase.from(syncTable).select('*').eq('id', 1).single();
    if (data) {
      const video = playlist.find(v => v.id === data.syncid);
      if (video) {
        currentIndex = playlist.findIndex(v => v.id === data.syncid);
        reproduzir(video.youtube_id, video.id);
      } else {
        reproduzir(playlist[0].youtube_id, playlist[0].id);
      }
    } else {
      reproduzir(playlist[0].youtube_id, playlist[0].id);
    }
    carregarAPIDoYoutube();
  };
</script>
</body>
</html>
