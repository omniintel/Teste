<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>OmniPlayer</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: white; padding: 20px; }
    #player-wrapper { width: 100%; height: 300px; background: #000; margin-bottom: 20px; position: relative; }
    .yt-player {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* sÃ³ player ativo terÃ¡ eventos */
      opacity: 0;
      transition: opacity 1s ease;
    }
    .yt-player.active {
      pointer-events: auto;
      opacity: 1;
      z-index: 2;
    }
    #sync-status { padding: 10px 20px; background: #00c3ff; color: white; border: none; border-radius: 8px; display: inline-block; }
    #playlist { display: flex; flex-wrap: wrap; gap: 10px; }
    .video-item { background: #222; padding: 10px; border-radius: 8px; width: 150px; cursor: pointer; transition: transform 0.2s; }
    .video-item:hover { transform: scale(1.03); }
    .thumbnail { width: 100%; border-radius: 4px; }
    .title { margin-top: 5px; font-size: 14px; color: #ddd; }
  </style>
</head>
<body>
  <h1>ðŸŽ® OmniPlayer</h1>
  <div id="player-wrapper">
    <div id="playerA" class="yt-player"></div>
    <div id="playerB" class="yt-player"></div>
  </div>
  <div id="sync-status">ðŸ”„ Verificando...</div>
  <div id="playlist"></div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    const supabaseUrl = 'https://hgxuakniyncpbuvksiql.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhneHVha25peW5jcGJ1dmtzaXFsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODcyNTA2MCwiZXhwIjoyMDY0MzAxMDYwfQ.PqFYkPC-87s3regeKRhfMsZi9t_at-LxQTP23RGOyEo';
    const playlistTable = 'videos';
    const syncTable = 'current_video';

    let playlist = [];
    let currentIndex = 0;
    let syncIdAtual = null;

    let playerA, playerB;
    let activePlayer = 'A'; // qual player estÃ¡ tocando: 'A' ou 'B'
    let crossfadeDuration = 10; // segundos para iniciar crossfade antes do fim
    let checkInterval;

    // Load videos da API
    async function fetchVideos() {
      const res = await fetch(`${supabaseUrl}/rest/v1/${playlistTable}?select=*`, {
        headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}` }
      });
      const data = await res.json();
      return data.sort((a,b) => a.id - b.id);
    }

    async function updateSync(syncid, link) {
      await fetch(`${supabaseUrl}/rest/v1/${syncTable}?id=eq.1`, {
        method: 'PATCH',
        headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ syncid, sync: link })
      });
    }

    async function fetchSync() {
      const res = await fetch(`${supabaseUrl}/rest/v1/${syncTable}?id=eq.1&select=*`, {
        headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}` }
      });
      const data = await res.json();
      return data.length > 0 ? data[0] : null;
    }

    // Extrai ID do YouTube do link ou embed
    function extractId(url) {
      if (!url) return '';
      if (url.includes('embed/')) return url.split('embed/')[1].split('?')[0];
      if (url.includes('v=')) return url.split('v=')[1].split('&')[0];
      return url; // jÃ¡ Ã© sÃ³ id
    }

    // Renderiza playlist
    function renderPlaylist() {
      const container = document.getElementById('playlist');
      container.innerHTML = '';
      playlist.forEach((video, index) => {
        const item = document.createElement('div');
        item.className = 'video-item';

        const youtubeId = extractId(video.youtube_id);
        const thumbnail = document.createElement('img');
        thumbnail.src = `https://img.youtube.com/vi/${youtubeId}/default.jpg`;
        thumbnail.className = 'thumbnail';

        const title = document.createElement('div');
        title.className = 'title';
        title.innerText = `${index+1}. ${video.title || 'VÃ­deo'}`;

        item.onclick = () => setVideo(index);

        item.appendChild(thumbnail);
        item.appendChild(title);
        container.appendChild(item);
      });
    }

    // Carrega vÃ­deo no player (faz o crossfade)
    function setVideo(index) {
      if(index < 0 || index >= playlist.length) return;
      const video = playlist[index];
      const youtubeId = extractId(video.youtube_id);
      syncIdAtual = video.id;
      currentIndex = index;

      // Qual player estÃ¡ ativo e qual serÃ¡ o prÃ³ximo
      const currentP = activePlayer === 'A' ? playerA : playerB;
      const nextP = activePlayer === 'A' ? playerB : playerA;

      // Carregar prÃ³ximo vÃ­deo no player "inativo"
      nextP.setVolume(0);
      nextP.loadVideoById(youtubeId);
      updateSync(video.id, `https://www.youtube.com/embed/${youtubeId}`);

      // ComeÃ§ar crossfade (se for o primeiro vÃ­deo, faz fade imediato)
      if (!currentP.getPlayerState || currentP.getPlayerState() === YT.PlayerState.UNSTARTED) {
        // Primeiro vÃ­deo (sem crossfade)
        activePlayer = activePlayer === 'A' ? 'B' : 'A';
        nextP.setVolume(100);
        nextP.playVideo();
        showActivePlayer();
      } else {
        startCrossfade();
      }
    }

    // Mostra o player ativo visÃ­vel
    function showActivePlayer() {
      if(activePlayer === 'A') {
        document.getElementById('playerA').classList.add('active');
        document.getElementById('playerB').classList.remove('active');
      } else {
        document.getElementById('playerB').classList.add('active');
        document.getElementById('playerA').classList.remove('active');
      }
    }

    // Inicia o crossfade de 10 segundos
    function startCrossfade() {
      const fadeSteps = 20; // nÃºmero de passos do fade
      const fadeInterval = (crossfadeDuration * 1000) / fadeSteps;
      let step = 0;

      const currentP = activePlayer === 'A' ? playerA : playerB;
      const nextP = activePlayer === 'A' ? playerB : playerA;

      nextP.playVideo();

      const fadeTimer = setInterval(() => {
        step++;
        const volumeOut = Math.max(0, 100 - (step * (100 / fadeSteps)));
        const volumeIn = Math.min(100, step * (100 / fadeSteps));

        currentP.setVolume(volumeOut);
        nextP.setVolume(volumeIn);

        if(step >= fadeSteps) {
          clearInterval(fadeTimer);
          currentP.pauseVideo();
          activePlayer = activePlayer === 'A' ? 'B' : 'A';
          showActivePlayer();
        }
      }, fadeInterval);
    }

    // Detecta e comeÃ§a o crossfade 10 segundos antes do fim
    function checkCrossfade() {
      const currentP = activePlayer === 'A' ? playerA : playerB;
      if(currentP && currentP.getDuration && currentP.getCurrentTime) {
        const duration = currentP.getDuration();
        const currentTime = currentP.getCurrentTime();
        if(duration > 0 && duration - currentTime <= crossfadeDuration) {
          clearInterval(checkInterval);
          // ComeÃ§a o prÃ³ximo vÃ­deo
          playNext();
          // Reativa o check depois do crossfadeDuration + 2s para evitar mÃºltiplos triggers
          setTimeout(() => {
            checkInterval = setInterval(checkCrossfade, 500);
          }, (crossfadeDuration + 2) * 1000);
        }
      }
    }

    function playNext() {
      let nextIndex = (currentIndex + 1) % playlist.length;
      setVideo(nextIndex);
    }

    // Sincroniza com current_video
    async function syncChecker() {
      const data = await fetchSync();
      if(data && data.syncid !== syncIdAtual) {
        const index = playlist.findIndex(v => v.id === data.syncid);
        if(index >= 0) setVideo(index);
      }
    }

    // API do YouTube pronta
    function onYouTubeIframeAPIReady() {
      playerA = new YT.Player('playerA', {
        height: '100%',
        width: '100%',
        videoId: '',
        playerVars: { autoplay: 0, controls: 1 },
        events: { onStateChange: onPlayerStateChange }
      });
      playerB = new YT.Player('playerB', {
        height: '100%',
        width: '100%',
        videoId: '',
        playerVars: { autoplay: 0, controls: 1 },
        events: { onStateChange: onPlayerStateChange }
      });
    }

    function onPlayerStateChange(event) {
      if(event.data === YT.PlayerState.ENDED) {
        playNext();
      }
    }

    // Atualiza o status da playlist (sem reload da pÃ¡gina)
    async function updateSyncStatus() {
      const statusEl = document.getElementById('sync-status');
      const buttonStatus = await checkButtonStatus();

      if(buttonStatus === 1) {
        statusEl.innerText = 'ðŸ”„ Atualizando Playlist...';
        await updateButtonState(0);
        await reloadPlaylist();
      } else {
        statusEl.innerText = 'âœ… Playlist Atualizada';
      }
    }

    // Check Button
    async function checkButtonStatus() {
      const res = await fetch(`${supabaseUrl}/rest/v1/${syncTable}?id=eq.1&select=Button`, {
        headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}` }
      });
      const data = await res.json();
      return data.length > 0 ? data[0].Button : null;
    }

    async function updateButtonState(value) {
      await fetch(`${supabaseUrl}/rest/v1/${syncTable}?id=eq.1`, {
        method: 'PATCH',
        headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ Button: value })
      });
    }

    async function reloadPlaylist() {
      playlist = await fetchVideos();
      renderPlaylist();
    }

    async function loadApp() {
      await reloadPlaylist();
      await updateButtonState(0);
      const sync = await fetchSync();
      if(sync) {
        const index = playlist.findIndex(v => v.id === sync.syncid);
        if(index >= 0) setVideo(index);
        else if(playlist.length > 0) setVideo(0);
      } else if(playlist.length > 0) {
        setVideo(0);
      }
      checkInterval = setInterval(checkCrossfade, 500);
      setInterval(syncChecker, 1000);
      setInterval(updateSyncStatus, 2000);
    }

    loadApp();
  </script>
</body>
</html>
