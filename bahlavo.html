<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>OmniPlayer</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #111; color: white; overflow: hidden; }
    #player-wrapper { position: relative; width: 100vw; height: 100vh; background: #000; }
    #player { width: 100%; height: 100%; }

    /* Overlay de informações do vídeo (bottom-left) */
    #video-info {
      position: absolute;
      left: 1vw;
      bottom: 1vh;
      background: rgba(0, 0, 0, 0.7);
      padding: 14px;
      border-radius: 12px;
      display: none; /* controlado via JS */
      max-width: min(36vw, 420px);
      z-index: 30;
      will-change: transform, opacity;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    #video-info img {
      width: 100%;
      border-radius: 8px;
      display: block;
    }
    #video-info h2 {
      margin: 10px 0 0;
      font-size: clamp(14px, 1.8vw, 18px);
      color: #fff;
      line-height: 1.25;
      font-weight: 600;
    }

    /* Animações de entrada/saída (esquerda -> direita) */
    .info-enter { animation: slideInLR 0.45s ease-out forwards; }
    .info-exit  { animation: slideOutLR 0.30s ease-in forwards; }
    @keyframes slideInLR {
      0%   { transform: translateX(-110%); opacity: 0; }
      100% { transform: translateX(0);      opacity: 1; }
    }
    @keyframes slideOutLR {
      0%   { transform: translateX(0);      opacity: 1; }
      100% { transform: translateX(110%);   opacity: 0; }
    }

    /* Playlist (mantida) */
    #playlist { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: #111; }
    .video-item { background: #222; padding: 10px; border-radius: 8px; width: 150px; cursor: pointer; transition: transform 0.2s; }
    .video-item:hover { transform: scale(1.03); }
    .thumbnail { width: 100%; border-radius: 4px; }
    .title { margin-top: 5px; font-size: 14px; color: #ddd; }

    /* Relógio (top-left) */
    #clockContainer {
      position: absolute;
      top: 1vh; left: 1vw;
      z-index: 25;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 1.5vw;
      backdrop-filter: blur(6px);
      padding: 0.8rem 1.2rem;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.15);
    }
    #dateText {
      font-size: clamp(12px, 1.4vw, 18px);
      margin-bottom: 0.5rem;
      text-transform: capitalize;
    }
    #timeText {
      display: flex;
      gap: 0.35rem;
      justify-content: center;
    }
    .timeDigit {
      width: clamp(28px, 3vw, 60px);
      height: clamp(40px, 5vw, 90px);
      background: rgba(255, 255, 255, 0.15);
      border: 1.5px solid rgba(255,255,255,0.28);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: clamp(16px, 2.2vw, 28px);
      border-radius: 10px;
    }
    .flip { animation: flipDown 0.5s ease-in-out; }
    @keyframes flipDown {
      0% { transform: rotateX(-90deg); opacity: 0; }
      100% { transform: rotateX(0deg); opacity: 1; }
    }

    /* Clima (top-right) */
    #weatherBox {
      position: absolute;
      top: 1vh; right: 1vw;
      z-index: 25;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(6px);
      border-radius: 1.2vw;
      padding: 0.8rem 1.2rem;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.15);
    }
    #weatherBox .emoji {
      font-size: clamp(14px, 1.6vw, 22px);
      margin-bottom: 0.3rem;
      white-space: nowrap;
    }
    #weatherBox .temperature {
      font-size: clamp(18px, 2.4vw, 34px);
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="player-wrapper">
    <div id="player"></div>

    <!-- Overlays que ficam acima do vídeo -->
    <div id="clockContainer">
      <div id="dateText">Carregando data...</div>
      <div id="timeText"></div>
    </div>

    <div id="weatherBox">
      <div class="emoji">⏳ Carregando...</div>
      <div class="temperature">--</div>
    </div>

    <div id="video-info"></div>
  </div>

  <!-- Playlist (opcional, mantida) -->
  <div id="playlist"></div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    const supabaseUrl = 'https://hgxuakniyncpbuvksiql.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhneHVha25peW5jcGJ1dmtzaXFsIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODcyNTA2MCwiZXhwIjoyMDY0MzAxMDYwfQ.PqFYkPC-87s3regeKRhfMsZi9t_at-LxQTP23RGOyEo';
    const playlistTable = 'videos';
    const syncTable = 'current_video';

    let playlist = [];
    let currentIndex = 0;
    let syncIdAtual = null;
    let ytPlayer;

    // Controle do overlay de info
    const INFO_DURATION = 10000; // 10s visível
    let infoTimeout = null;
    let isExiting = false;

    // === API SUPABASE ===
    const fetchVideos = async () => {
      const res = await fetch(`${supabaseUrl}/rest/v1/${playlistTable}?select=*`, {
        headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}` }
      });
      const data = await res.json();
      return data.sort((a, b) => a.id - b.id);
    };

    const updateSync = async (syncid, link) => {
      await fetch(`${supabaseUrl}/rest/v1/${syncTable}?id=eq.1`, {
        method: 'PATCH',
        headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ syncid: syncid, sync: link })
      });
    };

    const fetchSync = async () => {
      const res = await fetch(`${supabaseUrl}/rest/v1/${syncTable}?id=eq.1&select=*`, {
        headers: { apikey: supabaseKey, Authorization: `Bearer ${supabaseKey}` }
      });
      const data = await res.json();
      return data.length > 0 ? data[0] : null;
    };

    // === INTERFACE ===
    const renderPlaylist = () => {
      const container = document.getElementById('playlist');
      container.innerHTML = '';
      playlist.forEach((video, index) => {
        const item = document.createElement('div');
        item.className = 'video-item';

        const youtubeId = extractId(video.youtube_id);
        const thumbnail = document.createElement('img');
        thumbnail.src = `https://img.youtube.com/vi/${youtubeId}/default.jpg`;
        thumbnail.className = 'thumbnail';

        const title = document.createElement('div');
        title.className = 'title';
        title.innerText = `${index + 1}. ${video.title || 'Vídeo'}`;

        item.onclick = () => setVideo(index);
        item.appendChild(thumbnail);
        item.appendChild(title);
        container.appendChild(item);
      });
    };

    // === PLAYER YOUTUBE (mantido) ===
    function onYouTubeIframeAPIReady() {
      ytPlayer = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: '',
        playerVars: { autoplay: 1, controls: 1 },
        events: { onStateChange: onPlayerStateChange }
      });
    }

    const setVideo = (index) => {
      const video = playlist[index];
      if (!video) return;

      const youtubeId = extractId(video.youtube_id);
      ytPlayer.loadVideoById(youtubeId);
      currentIndex = index;
      syncIdAtual = video.id;
      updateSync(video.id, `https://www.youtube.com/embed/${youtubeId}`);

      showVideoInfo(video, youtubeId); // só mexemos no overlay
    };

    const onPlayerStateChange = (event) => {
      if (event.data === YT.PlayerState.ENDED) playNext();
    };

    const playNext = () => {
      const nextIndex = (currentIndex + 1) % playlist.length;
      setVideo(nextIndex);
    };

    // === SINCRONIZAÇÃO ===
    const syncChecker = async () => {
      const data = await fetchSync();
      if (data && data.syncid !== syncIdAtual) {
        const index = playlist.findIndex(v => v.id === data.syncid);
        if (index >= 0) setVideo(index);
      }
    };

    // === AUXILIARES ===
    const extractId = (url) => {
      if (!url) return '';
      if (url.includes('embed/')) return url.split('embed/')[1].split('?')[0];
      if (url.includes('v=')) return url.split('v=')[1].split('&')[0];
      return url; // já é ID
    };

    const reloadPlaylist = async () => {
      playlist = await fetchVideos();
      renderPlaylist();
    };

    const loadApp = async () => {
      await reloadPlaylist();
      const sync = await fetchSync();
      if (sync) {
        const index = playlist.findIndex(v => v.id === sync.syncid);
        if (index >= 0) setVideo(index);
      } else if (playlist.length > 0) {
        setVideo(0);
      }
    };

    // === OVERLAY: entrar/ficar 10s/sair; troca sem sobreposição ===
    function setInfoContent(video, youtubeId) {
      const infoBox = document.getElementById('video-info');
      infoBox.innerHTML = `
        <img src="https://img.youtube.com/vi/${youtubeId}/hqdefault.jpg" alt="thumbnail">
        <h2>${video.title || 'Sem título'}</h2>
      `;
    }

    function hideInfoImmediate() {
      const infoBox = document.getElementById('video-info');
      infoBox.style.display = 'none';
      infoBox.classList.remove('info-enter', 'info-exit');
      isExiting = false;
      clearTimeout(infoTimeout);
      infoTimeout = null;
    }

    function showVideoInfo(video, youtubeId) {
      const infoBox = document.getElementById('video-info');

      // Se já está visível, executa uma saída curta e só então mostra o novo (evita sobreposição)
      if (infoBox.style.display === 'block' && !isExiting) {
        isExiting = true;
        infoBox.classList.remove('info-enter');
        infoBox.classList.add('info-exit');
        clearTimeout(infoTimeout);
        infoBox.addEventListener('animationend', () => {
          hideInfoImmediate();
          // Agora entra o novo
          setInfoContent(video, youtubeId);
          infoBox.style.display = 'block';
          void infoBox.offsetWidth; // reflow para reiniciar animação
          infoBox.classList.add('info-enter');
          isExiting = false;

          infoTimeout = setTimeout(() => startInfoExit(), INFO_DURATION);
        }, { once: true });
        return;
      }

      // Caso contrário, apenas mostra
      clearTimeout(infoTimeout);
      setInfoContent(video, youtubeId);
      infoBox.style.display = 'block';
      infoBox.classList.remove('info-exit');
      void infoBox.offsetWidth;
      infoBox.classList.add('info-enter');

      infoTimeout = setTimeout(() => startInfoExit(), INFO_DURATION);
    }

    function startInfoExit() {
      const infoBox = document.getElementById('video-info');
      if (infoBox.style.display !== 'block' || isExiting) return;
      isExiting = true;
      infoBox.classList.remove('info-enter');
      infoBox.classList.add('info-exit');
      infoBox.addEventListener('animationend', () => {
        hideInfoImmediate();
      }, { once: true });
    }

    // === Relógio ===
    let previousTime = '';
    function updateClock() {
      const dateEl = document.getElementById('dateText');
      const timeContainer = document.getElementById('timeText');
      const now = new Date();

      const options = { weekday: 'long', day: 'numeric', month: 'long' };
      dateEl.textContent = now.toLocaleDateString('pt-BR', options);

      const timeStr = now.toTimeString().slice(0, 8);
      const currentChars = timeStr.split('');

      if (timeContainer.children.length !== currentChars.length) {
        timeContainer.innerHTML = '';
        currentChars.forEach(char => {
          const span = document.createElement('div');
          span.className = 'timeDigit';
          span.textContent = char;
          timeContainer.appendChild(span);
        });
      } else {
        currentChars.forEach((char, i) => {
          const digitEl = timeContainer.children[i];
          if (digitEl.textContent !== char) {
            digitEl.classList.remove('flip');
            void digitEl.offsetWidth;
            digitEl.classList.add('flip');
            digitEl.textContent = char;
          }
        });
      }
      previousTime = timeStr;
    }

    // === Clima ===
    async function updateWeather() {
      const apiKey = '0aeb1d92eb76b16aed4cde075eeb9955';
      const cidade = 'Santa Rosa,BR';
      const url = `https://api.openweathermap.org/data/2.5/weather?q=${cidade}&units=metric&lang=pt_br&appid=${apiKey}`;
      const box = document.getElementById('weatherBox');
      try {
        const res = await fetch(url);
        const data = await res.json();
        const temp = Math.round(data.main.temp);
        const main = (data.weather?.[0]?.main || '').toLowerCase();

        const emojiMap = {
          clear: '☀️', clouds: '☁️', rain: '🌧️',
          drizzle: '🌦️', thunderstorm: '⛈️',
          snow: '❄️', mist: '🌫️', fog: '🌁'
        };
        const emoji = emojiMap[main] || '🌈';
        box.querySelector('.emoji').textContent = `${emoji} - Santa Rosa`;
        box.querySelector('.temperature').textContent = `${temp}°`;
      } catch (e) {
        box.querySelector('.emoji').textContent = "⚠️ Erro ao obter clima";
        box.querySelector('.temperature').textContent = "--";
      }
    }

    // === INTERVALOS ===
    setInterval(syncChecker, 1000);      // sincronização de vídeo (mantido)
    setInterval(updateClock, 1000);      // relógio
    updateClock();

    updateWeather();
    setInterval(updateWeather, 600000);  // clima a cada 10 min

    // Boot
    loadApp();
  </script>
</body>
</html>
